{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workbook-azure-arc-sql-databases-name": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "The resource name for the Azure Arc SQL Databases workbook. Should be GUID. Please do not change the parameter value from the default."
            }
        },
        "workbook-azure-arc-sql-servers-best-practices-analyzer-name": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "The resource name for the Azure Arc SQL Servers Best Practices Analyzer workbook. Should be GUID. Please do not change the parameter value from the default."
            }
        },
        "workbook-azure-arc-sql-servers-name": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "The resource name for the Azure Arc SQL Servers workbook. Should be GUID. Please do not change the parameter value from the default."
            }
        }
    },
    "functions": [],
    "variables": {
        "workbook-azure-arc-sql-databases-display-name": "Azure Arc SQL Databases",
        "workbook-azure-arc-sql-servers-best-practices-analyzer-display-name": "Azure Arc SQL Servers - Best Practices Analyzer",
        "workbook-azure-arc-sql-servers-display-name": "Azure Arc SQL Servers",
        "workbook-source-id": "Azure Monitor",
        "workbook-category": "workbook",
        "region": "[resourceGroup().location]"
    },
    "resources": [
        {
            "name": "[parameters('workbook-azure-arc-sql-databases-name')]",
            "type": "Microsoft.Insights/workbooks",
            "location": "[variables('region')]",
            "kind": "shared",
            "apiVersion": "2018-06-17-preview",
            "dependsOn": [],
            "properties": {
                "displayName": "[variables('workbook-azure-arc-sql-databases-display-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Azure Arc SQL Databases\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.azurearcdata/sqlserverinstances/databases\\\"\\r\\n| extend compatibilityLevel =  tostring(properties['compatibilityLevel'])\\r\\n| summarize Databases = count(compatibilityLevel) by compatibilityLevel\",\"size\":3,\"title\":\"Count of Databases by Compatibility Level\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"33\",\"name\":\"Count of Databases by Compatibility Level\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.azurearcdata/sqlserverinstances/databases\\\"\\r\\n| extend recoveryMode = tostring(properties.recoveryMode)\\r\\n| summarize Databases = count(recoveryMode) by recoveryMode\",\"size\":3,\"title\":\"Count of Databases by Recovery Model\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"33\",\"name\":\"Query 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.azurearcdata/sqlserverinstances/databases\\\"\\r\\n| extend lastFullBackup = iff(isnull(properties['backupInformation']['lastFullBackup']),'False','True')\\r\\n| summarize Databases = count(lastFullBackup) by lastFullBackup\",\"size\":3,\"title\":\"Count of Databases by Full Backup\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true,\"seriesLabelSettings\":[{\"seriesName\":\"True\",\"color\":\"green\"},{\"seriesName\":\"False\",\"color\":\"redBright\"}]}},\"customWidth\":\"33\",\"name\":\"Query 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.azurearcdata/sqlserverinstances/databases\\\"\\r\\n| extend compatibilityLevel =  tostring(properties['compatibilityLevel'])\\r\\n| extend lastFullBackup = properties['backupInformation']['lastFullBackup']\\r\\n| extend  lastLogBackup = properties['backupInformation']['lastLogBackup']\\r\\n| extend Instance = split(['id'],'/Databases')[0]\\r\\n| project Instance, Database = id ,lastFullBackup = format_datetime(todatetime(lastFullBackup), \\\"yyyy-MM-dd HH:mm:ss\\\"),lastLogBackup = format_datetime(todatetime(lastLogBackup), \\\"yyyy-MM-dd HH:mm:ss\\\"),compatibilityLevel,recoveryMode = properties.recoveryMode\",\"size\":3,\"title\":\"Databases Backup State\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Instance\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}},{\"columnMatch\":\"Database\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"56.714ch\"}}],\"rowLimit\":1000,\"filter\":true},\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"name\":\"Query2\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
                "version": "1.0",
                "sourceId": "[variables('workbook-source-id')]",
                "category": "[variables('workbook-category')]"
            }
        },
        {
            "name": "[parameters('workbook-azure-arc-sql-servers-best-practices-analyzer-name')]",
            "type": "Microsoft.Insights/workbooks",
            "location": "[variables('region')]",
            "kind": "shared",
            "apiVersion": "2018-06-17-preview",
            "dependsOn": [],
            "properties": {
                "displayName": "[variables('workbook-azure-arc-sql-servers-best-practices-analyzer-display-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Azure Arc SQL Servers - Best Practices Analyzer\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"5ccbaa77-2a42-4a07-a877-b5a3a6297703\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"includeAll\":true,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"value\":[\"value::all\"]},{\"id\":\"f932fba5-395b-423d-a9b0-538714e1e553\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LogAnalitycsWorkpace\",\"type\":5,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project id\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":null}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SqlAssessment_CL\\r\\n| extend asmt = parse_csv(RawData)\\r\\n| extend\\r\\n    AsmtId=tostring(asmt[1]),\\r\\n    CheckId=tostring(asmt[2]),\\r\\n    DisplayString=asmt[3],\\r\\n    Description=tostring(asmt[4]),\\r\\n    HelpLink=asmt[5],\\r\\n    TargetType=case(asmt[6] == 1, \\\"Server\\\", asmt[6] == 2, \\\"Database\\\", \\\"\\\"),\\r\\n    TargetName=tostring(asmt[7]), \\r\\n    Severity=case(asmt[8] == 30, \\\"High\\\", asmt[8] == 20, \\\"Medium\\\", asmt[8] == 10, \\\"Low\\\", asmt[8] == 0, \\\"Information\\\", asmt[8] == 1, \\\"Warning\\\", asmt[8] == 2, \\\"Critical\\\", \\\"Passed\\\"),\\r\\n    Message=tostring(asmt[9]),\\r\\n    TagsArr=split(tostring(asmt[10]), \\\",\\\"),\\r\\n    Sev = toint(asmt[8])\\r\\n    | order by CheckId, _ResourceId\\r\\n    | join kind=inner\\r\\n    (\\r\\n    SqlAssessment_CL\\r\\n    | extend asmt = parse_csv(RawData)\\r\\n    | extend\\r\\n        AsmtId=tostring(asmt[1])   \\r\\n    | summarize arg_max(TimeGenerated, *) by _ResourceId\\r\\n    | project AsmtId\\r\\n    ) on AsmtId\\r\\n    |where Sev >= 0\\r\\n    | summarize count() by Severity, Sev\\r\\n    | order by Sev\",\"size\":3,\"title\":\"Issues by severity\",\"exportFieldName\":\"Severity\",\"exportParameterName\":\"severity\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Severity\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":40,\"palette\":\"coldHot\"}},{\"columnMatch\":\"Sev\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":40,\"palette\":\"coldHot\"}}]},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Medium\",\"color\":\"orange\"},{\"seriesName\":\"Low\",\"color\":\"blue\"},{\"seriesName\":\"High\",\"color\":\"redBright\"},{\"seriesName\":\"Information\",\"color\":\"blueDark\"}],\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"customWidth\":\"33\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nSqlAssessment_CL\\r\\n| extend asmt = parse_csv(RawData)\\r\\n| extend\\r\\n    AsmtId=tostring(asmt[1]),\\r\\n    CheckId=tostring(asmt[2]),\\r\\n    DisplayString=asmt[3],\\r\\n    Description=tostring(asmt[4]),\\r\\n    HelpLink=asmt[5],\\r\\n    TargetType=case(asmt[6] == 1, \\\"Server\\\", asmt[6] == 2, \\\"Database\\\", \\\"\\\"),\\r\\n    TargetName=tostring(asmt[7]), \\r\\n    Severity=case(asmt[8] == 30, \\\"High\\\", asmt[8] == 20, \\\"Medium\\\", asmt[8] == 10, \\\"Low\\\", asmt[8] == 0, \\\"Information\\\", asmt[8] == 1, \\\"Warning\\\", asmt[8] == 2, \\\"Critical\\\", \\\"Passed\\\"),\\r\\n    Message=tostring(asmt[9]),\\r\\n    TagsArr=split(tostring(asmt[10]), \\\",\\\"),\\r\\n    Sev = toint(asmt[8])\\r\\n    | order by CheckId, _ResourceId\\r\\n    | join kind=inner\\r\\n    (\\r\\n    SqlAssessment_CL\\r\\n    | extend asmt = parse_csv(RawData)\\r\\n    | extend\\r\\n        AsmtId=tostring(asmt[1])   \\r\\n    | summarize arg_max(TimeGenerated, *) by _ResourceId\\r\\n    | project AsmtId\\r\\n    ) on AsmtId\\r\\n    |where Sev >= 0   \\r\\n    and Severity == \\\"{severity}\\\"\\r\\n    | order by Sev, CheckId\\r\\n    | project CheckId, Description, _ResourceId, AsmtId, Sev, Severity \\r\\n\",\"size\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"]},\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SqlAssessment_CL\\r\\n| extend asmt = parse_csv(RawData)\\r\\n| extend\\r\\n    AsmtId=tostring(asmt[1]),\\r\\n    CheckId=tostring(asmt[2]),\\r\\n    DisplayString=asmt[3],\\r\\n    Description=tostring(asmt[4]),\\r\\n    HelpLink=asmt[5],\\r\\n    TargetType=case(asmt[6] == 1, \\\"Server\\\", asmt[6] == 2, \\\"Database\\\", \\\"\\\"),\\r\\n    TargetName=tostring(asmt[7]), \\r\\n    Severity=case(asmt[8] == 30, \\\"High\\\", asmt[8] == 20, \\\"Medium\\\", asmt[8] == 10, \\\"Low\\\", asmt[8] == 0, \\\"Information\\\", asmt[8] == 1, \\\"Warning\\\", asmt[8] == 2, \\\"Critical\\\", \\\"Passed\\\"),\\r\\n    Message=tostring(asmt[9]),\\r\\n    TagsArr=split(tostring(asmt[10]), \\\",\\\"),\\r\\n    Sev = toint(asmt[8])\\r\\n    | order by CheckId, _ResourceId\\r\\n    | join kind=inner\\r\\n    (\\r\\n    SqlAssessment_CL\\r\\n    | extend asmt = parse_csv(RawData)\\r\\n    | extend\\r\\n        AsmtId=tostring(asmt[1])   \\r\\n    | summarize arg_max(TimeGenerated, *) by _ResourceId\\r\\n    | project AsmtId\\r\\n    ) on AsmtId\\r\\n    |where Sev >= 0   \\r\\n    and TargetType == \\\"Server\\\"\\r\\n    | order by Sev, CheckId\\r\\n    | summarize count() by TargetName \\r\\n\",\"size\":3,\"title\":\"Issues by server\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Protected\",\"color\":\"green\"},{\"seriesName\":\"Unknown\",\"color\":\"gray\"},{\"seriesName\":\"Not Protected\",\"color\":\"redBright\"}]}},\"customWidth\":\"33\",\"name\":\"query - 4 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SqlAssessment_CL\\r\\n| extend asmt = parse_csv(RawData)\\r\\n| extend\\r\\n    AsmtId=tostring(asmt[1]),\\r\\n    CheckId=tostring(asmt[2]),\\r\\n    DisplayString=asmt[3],\\r\\n    Description=tostring(asmt[4]),\\r\\n    HelpLink=asmt[5],\\r\\n    TargetType=case(asmt[6] == 1, \\\"Server\\\", asmt[6] == 2, \\\"Database\\\", \\\"\\\"),\\r\\n    TargetName=tostring(asmt[7]), \\r\\n    Severity=case(asmt[8] == 30, \\\"High\\\", asmt[8] == 20, \\\"Medium\\\", asmt[8] == 10, \\\"Low\\\", asmt[8] == 0, \\\"Information\\\", asmt[8] == 1, \\\"Warning\\\", asmt[8] == 2, \\\"Critical\\\", \\\"Passed\\\"),\\r\\n    Message=tostring(asmt[9]),\\r\\n    TagsArr=split(tostring(asmt[10]), \\\",\\\"),\\r\\n    Sev = toint(asmt[8])\\r\\n    | order by CheckId, _ResourceId\\r\\n    | join kind=inner\\r\\n    (\\r\\n    SqlAssessment_CL\\r\\n    | extend asmt = parse_csv(RawData)\\r\\n    | extend\\r\\n        AsmtId=tostring(asmt[1])   \\r\\n    | summarize arg_max(TimeGenerated, *) by _ResourceId\\r\\n    | project AsmtId\\r\\n    ) on AsmtId\\r\\n    |where Sev >= 0   \\r\\n    and TargetType == \\\"Database\\\"\\r\\n    | order by Sev, CheckId\\r\\n    | summarize count() by TargetName \\r\\n\",\"size\":3,\"title\":\"Issues by Database\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 4 - Copy - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"],\"parameters\":[{\"id\":\"ced45d66-52da-4f9c-b473-6781309a78cc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckId\",\"type\":2,\"isRequired\":true,\"query\":\"\\r\\nSqlAssessment_CL\\r\\n| extend asmt = parse_csv(RawData)\\r\\n| extend\\r\\n    AsmtId=tostring(asmt[1]),\\r\\n    CheckId=tostring(asmt[2]),\\r\\n    DisplayString=asmt[3],\\r\\n    Description=tostring(asmt[4]),\\r\\n    HelpLink=asmt[5],\\r\\n    TargetType=case(asmt[6] == 1, \\\"Server\\\", asmt[6] == 2, \\\"Database\\\", \\\"\\\"),\\r\\n    TargetName=tostring(asmt[7]), \\r\\n    Severity=case(asmt[8] == 30, \\\"High\\\", asmt[8] == 20, \\\"Medium\\\", asmt[8] == 10, \\\"Low\\\", asmt[8] == 0, \\\"Information\\\", asmt[8] == 1, \\\"Warning\\\", asmt[8] == 2, \\\"Critical\\\", \\\"Passed\\\"),\\r\\n    Message=tostring(asmt[9]),\\r\\n    TagsArr=split(tostring(asmt[10]), \\\",\\\"),\\r\\n    Sev = toint(asmt[8])\\r\\n    | order by CheckId, _ResourceId\\r\\n    | join kind=inner\\r\\n    (\\r\\n    SqlAssessment_CL\\r\\n    | extend asmt = parse_csv(RawData)\\r\\n    | extend\\r\\n        AsmtId=tostring(asmt[1])   \\r\\n    | summarize arg_max(TimeGenerated, *) by _ResourceId\\r\\n    | project AsmtId\\r\\n    ) on AsmtId\\r\\n    |where Sev >= 0   \\r\\n    | distinct (CheckId)\\r\\n|order by CheckId asc\\r\\n\\r\\n\\r\\n   \",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":null}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"paarameter_CheckId\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SqlAssessment_CL\\r\\n| extend asmt = parse_csv(RawData)\\r\\n| extend\\r\\n    AsmtId=tostring(asmt[1]),\\r\\n    CheckId=tostring(asmt[2]),\\r\\n    DisplayString=asmt[3],\\r\\n    Description=tostring(asmt[4]),\\r\\n    HelpLink=asmt[5],\\r\\n    TargetType=case(asmt[6] == 1, \\\"Server\\\", asmt[6] == 2, \\\"Database\\\", \\\"\\\"),\\r\\n    TargetName=tostring(asmt[7]), \\r\\n    Severity=case(asmt[8] == 30, \\\"High\\\", asmt[8] == 20, \\\"Medium\\\", asmt[8] == 10, \\\"Low\\\", asmt[8] == 0, \\\"Information\\\", asmt[8] == 1, \\\"Warning\\\", asmt[8] == 2, \\\"Critical\\\", \\\"Passed\\\"),\\r\\n    Message=tostring(asmt[9]),\\r\\n    TagsArr=split(tostring(asmt[10]), \\\",\\\"),\\r\\n    Sev = toint(asmt[8])\\r\\n    | order by CheckId, _ResourceId\\r\\n    | join kind=inner\\r\\n    (\\r\\n    SqlAssessment_CL\\r\\n    | extend asmt = parse_csv(RawData)\\r\\n    | extend\\r\\n        AsmtId=tostring(asmt[1])   \\r\\n    | summarize arg_max(TimeGenerated, *) by _ResourceId\\r\\n    | project AsmtId\\r\\n    ) on AsmtId\\r\\n    |where Sev >= 0   \\r\\n    and CheckId ==\\\"{CheckId}\\\"\\r\\n    | project _ResourceId, tostring(DisplayString), TargetType, CheckId\\r\\n    | summarize count() by _ResourceId, tostring(DisplayString), TargetType, CheckId\\r\\n    | order by CheckId\",\"size\":3,\"title\":\"sqlmonitoring\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"createdAt\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"21.1429ch\"}},{\"columnMatch\":\"AzureArcServer\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20.1429ch\"}},{\"columnMatch\":\"SQLInstance\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"23.4286ch\"}},{\"columnMatch\":\"version\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"21ch\"}},{\"columnMatch\":\"currentVersion\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"patchLevel\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"17ch\"}},{\"columnMatch\":\"edition\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"11.4286ch\"}},{\"columnMatch\":\"vcores\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"9.7143ch\"}},{\"columnMatch\":\"subscriptionId\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"26.5714ch\"}},{\"columnMatch\":\"licenseType\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"14.4286ch\"}},{\"columnMatch\":\"azureDefenderStatus\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"}}],\"rowLimit\":500,\"filter\":true}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SqlAssessment_CL\\r\\n| extend asmt = parse_csv(RawData)\\r\\n| extend\\r\\n    AsmtId=tostring(asmt[1]),\\r\\n    CheckId=tostring(asmt[2]),\\r\\n    DisplayString=asmt[3],\\r\\n    Description=tostring(asmt[4]),\\r\\n    HelpLink=asmt[5],\\r\\n    TargetType=case(asmt[6] == 1, \\\"Server\\\", asmt[6] == 2, \\\"Database\\\", \\\"\\\"),\\r\\n    TargetName=tostring(asmt[7]), \\r\\n    Severity=case(asmt[8] == 30, \\\"High\\\", asmt[8] == 20, \\\"Medium\\\", asmt[8] == 10, \\\"Low\\\", asmt[8] == 0, \\\"Information\\\", asmt[8] == 1, \\\"Warning\\\", asmt[8] == 2, \\\"Critical\\\", \\\"Passed\\\"),\\r\\n    Message=tostring(asmt[9]),\\r\\n    TagsArr=split(tostring(asmt[10]), \\\",\\\"),\\r\\n    Sev = toint(asmt[8])\\r\\n    | order by CheckId, _ResourceId\\r\\n    | join kind=inner\\r\\n    (\\r\\n    SqlAssessment_CL\\r\\n    | extend asmt = parse_csv(RawData)\\r\\n    | extend\\r\\n        AsmtId=tostring(asmt[1])   \\r\\n    | summarize arg_max(TimeGenerated, *) by _ResourceId\\r\\n    | project AsmtId\\r\\n    ) on AsmtId\\r\\n    |where Sev >= 0\\r\\n    | order by Sev, CheckId\",\"size\":0,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalitycsWorkpace}\"]},\"name\":\"query - 0\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
                "version": "1.0",
                "sourceId": "[variables('workbook-source-id')]",
                "category": "[variables('workbook-category')]"
            }
        },
        {
            "name": "[parameters('workbook-azure-arc-sql-servers-name')]",
            "type": "Microsoft.Insights/workbooks",
            "location": "[variables('region')]",
            "kind": "shared",
            "apiVersion": "2018-06-17-preview",
            "dependsOn": [],
            "properties": {
                "displayName": "[variables('workbook-azure-arc-sql-servers-display-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Azure Arc SQL Server Instances\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"5ccbaa77-2a42-4a07-a877-b5a3a6297703\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"includeAll\":true,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"value\":[\"value::all\"]},{\"id\":\"43934901-a569-47a2-ab4e-116d2293204c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceGroup\",\"label\":\"Resource Group\",\"type\":2,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| summarize Count = count() by subscriptionId, resourceGroup\\r\\n| order by Count desc\\r\\n| extend Rank = row_number()\\r\\n| project label = resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"4b0fd3d8-de3e-41b8-88d9-7e704404ad6b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ServerName\",\"label\":\"Server Name Filter\",\"type\":1,\"value\":\"\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"SQLInstance\",\"type\":1,\"value\":\"\",\"id\":\"2df50306-76d2-4686-abaf-78f57430e75a\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.hybridcompute/machines'\\r\\n| where properties.detectedProperties.mssqldiscovered == \\\"true\\\" and properties.status != \\\"Expired\\\"\\r\\n| count\\r\\n| extend Tittle=\\\"Number of Azure Arc SQL Servers:\\\"\",\"size\":4,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Tittle\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":true,\"size\":\"auto\"}},\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ \\\"Microsoft.AzureArcData/sqlServerInstances\\\"\\r\\n| extend SQLInstance = id, AzureArcServer = tolower(tostring(properties.containerResourceId))\\r\\n| join kind=inner (resources\\r\\n| where type in ('microsoft.hybridcompute/machines')\\r\\n| where properties.status != \\\"Expired\\\"\\r\\n| extend id = tolower(id)) on $left.AzureArcServer == $right.id\\r\\n| where SQLInstance like \\\"{SQLInstance}\\\"\\r\\n| where AzureArcServer like \\\"{ServerName}\\\"\\r\\n| extend version = tostring(properties.version)\\r\\n| summarize count() by tostring(version)\\r\\n| sort by version\",\"size\":3,\"title\":\"SQL Versions\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"piechart\"},\"customWidth\":\"25\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ \\\"Microsoft.AzureArcData/sqlServerInstances\\\"\\r\\n| extend SQLInstance = id, AzureArcServer = tolower(tostring(properties.containerResourceId))\\r\\n| join kind=inner (resources\\r\\n| where type in ('microsoft.hybridcompute/machines')\\r\\n| where properties.status != \\\"Expired\\\"\\r\\n| extend id = tolower(id)) on $left.AzureArcServer == $right.id\\r\\n| where SQLInstance like \\\"{SQLInstance}\\\"\\r\\n| where AzureArcServer like \\\"{ServerName}\\\"\\r\\n| extend azureDefenderStatus = tostring(properties.azureDefenderStatus)\\r\\n| summarize count() by tostring(azureDefenderStatus)\\r\\n| sort by azureDefenderStatus\",\"size\":3,\"title\":\"Azure Defender Status\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Protected\",\"color\":\"green\"},{\"seriesName\":\"Unknown\",\"color\":\"gray\"},{\"seriesName\":\"Not Protected\",\"color\":\"redBright\"}]}},\"customWidth\":\"25\",\"name\":\"query - 4 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ \\\"Microsoft.AzureArcData/sqlServerInstances\\\"\\r\\n| extend SQLInstance = id, AzureArcServer = tolower(tostring(properties.containerResourceId))\\r\\n| join kind=inner (resources\\r\\n| where type in ('microsoft.hybridcompute/machines')\\r\\n| where properties.status != \\\"Expired\\\"\\r\\n| extend id = tolower(id)) on $left.AzureArcServer == $right.id\\r\\n| where SQLInstance like \\\"{SQLInstance}\\\"\\r\\n| where AzureArcServer like \\\"{ServerName}\\\"\\r\\n| extend edition = tostring(properties.edition)\\r\\n| summarize count() by tostring(edition)\\r\\n| sort by edition\",\"size\":3,\"title\":\"SQL Editions\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Protected\",\"color\":\"green\"},{\"seriesName\":\"Unknown\",\"color\":\"gray\"},{\"seriesName\":\"Not Protected\",\"color\":\"redBright\"}]}},\"customWidth\":\"25\",\"name\":\"query - 4 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ \\\"Microsoft.AzureArcData/sqlServerInstances\\\"\\r\\n| extend SQLInstance = id, AzureArcServer = tolower(tostring(properties.containerResourceId))\\r\\n| join kind=inner (resources\\r\\n| where type in ('microsoft.hybridcompute/machines')\\r\\n| where properties.status != \\\"Expired\\\"\\r\\n| extend id = tolower(id)) on $left.AzureArcServer == $right.id\\r\\n| where SQLInstance like \\\"{SQLInstance}\\\"\\r\\n| where AzureArcServer like \\\"{ServerName}\\\"\\r\\n| extend licenseType = tostring(properties.licenseType)\\r\\n| summarize count() by tostring(licenseType)\\r\\n| sort by licenseType\",\"size\":3,\"title\":\"LicenseType\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"piechart\"},\"customWidth\":\"25\",\"name\":\"query - 4 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ \\\"Microsoft.AzureArcData/sqlServerInstances\\\"\\r\\n| extend SQLInstance = id, AzureArcServer = tolower(tostring(properties.containerResourceId))\\r\\n| join kind=inner (resources\\r\\n| where type in ('microsoft.hybridcompute/machines')\\r\\n| where properties.status != \\\"Expired\\\"\\r\\n| extend id = tolower(id)) on $left.AzureArcServer == $right.id\\r\\n| where SQLInstance like \\\"{SQLInstance}\\\"\\r\\n| where AzureArcServer like \\\"{ServerName}\\\"\\r\\n| extend createdAt = format_datetime(todatetime(systemData.createdAt), 'yyyy-MM-dd hh:mm:ss')\\r\\n| extend version = tostring(properties.version)\\r\\n| extend edition = tostring(properties.edition)\\r\\n| extend currentVersion = tostring(properties.currentVersion)\\r\\n| extend licenseType = tostring(properties.licenseType)\\r\\n| extend azureDefenderStatus = tostring(properties.azureDefenderStatus)\\r\\n| extend patchLevel = tostring(properties.patchLevel)\\r\\n| extend vcores = toint(properties.vCore)\\r\\n| project createdAt,AzureArcServer,SQLInstance,version,currentVersion,patchLevel,edition,vcores,subscriptionId,licenseType,azureDefenderStatus\\r\\n\",\"size\":0,\"showAnalytics\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"createdAt\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"21.1429ch\"}},{\"columnMatch\":\"AzureArcServer\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20.1429ch\"}},{\"columnMatch\":\"SQLInstance\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"23.4286ch\"}},{\"columnMatch\":\"version\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"21ch\"}},{\"columnMatch\":\"currentVersion\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"patchLevel\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"17ch\"}},{\"columnMatch\":\"edition\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"11.4286ch\"}},{\"columnMatch\":\"vcores\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"9.7143ch\"}},{\"columnMatch\":\"subscriptionId\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"26.5714ch\"}},{\"columnMatch\":\"licenseType\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"14.4286ch\"}},{\"columnMatch\":\"azureDefenderStatus\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"}}],\"rowLimit\":500,\"filter\":true}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ \\\"microsoft.hybridcompute/machines\\\"\\r\\n| where properties.mssqlDiscovered == true\\r\\n| extend id = tolower(id)\\r\\n| join kind=leftouter (resources\\r\\n| where type =~ \\\"microsoft.hybridcompute/machines/extensions\\\"\\r\\n| where properties.type in (\\\"WindowsAgent.SqlServer\\\", \\\"AzureMonitorWindowsAgent\\\")\\r\\n| extend ArcServerResourceId = tolower(tostring(split(id, \\\"/extensions\\\")[0]))\\r\\n| project ArcServerResourceId, ExtensionType = tostring(properties.type), ExtensionState = tostring(properties.provisioningState)\\r\\n| summarize SqlExtensionInstalled = countif(ExtensionType == \\\"WindowsAgent.SqlServer\\\" and ExtensionState == \\\"Succeeded\\\"), AMAExtensionInstalled = countif(ExtensionType == \\\"AzureMonitorWindowsAgent\\\" and ExtensionState == \\\"Succeeded\\\") by ArcServerResourceId)\\r\\non $left.id == $right.ArcServerResourceId\\r\\n| join kind=leftouter (resources\\r\\n| where type =~ \\\"microsoft.azurearcdata/sqlserverinstances\\\"\\r\\n| project ArcServerId = tolower(tostring(properties.containerResourceId)), SqlServerId = id, InstanceName = properties.instanceName, Version = properties.version\\r\\n| summarize ArcSqlServerInstances = make_list(split(SqlServerId, \\\"/\\\")[8]) by ArcServerId)\\r\\non $left.id == $right.ArcServerId\\r\\n| project ArcServer = id, SqlExtensionInstalled = (SqlExtensionInstalled==1), AMAExtensionInstalled = (AMAExtensionInstalled == 1), ArcSqlServerInstances\\r\\n\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SqlExtensionInstalled\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"Important\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}},{\"columnMatch\":\"AMAExtensionInstalled\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"2\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}}],\"rowLimit\":500,\"filter\":true}},\"name\":\"query - 0\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
                "version": "1.0",
                "sourceId": "[variables('workbook-source-id')]",
                "category": "[variables('workbook-category')]"
            }
        }
    ],
    "outputs": {}
}